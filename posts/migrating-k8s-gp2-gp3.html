<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migrating K8s From GP2 to GP3 - kspears.com</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <header>
    <div class="header-inner">
      <h1><a href="../index.html">kspears.com</a></h1>
      <nav>
        <a href="../index.html">Home</a>
        <a href="../about.html">Me</a>
        <a href="../posts.html">Posts</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <main>
      <a href="../posts.html" class="back-link">← All posts</a>

      <article>
        <div class="post-featured-img">
          <img src="../static/images/stackgres_logo.jpg" alt="Stackgres">
        </div>
        <h1>Migrating K8s From GP2 to GP3</h1>
        <div class="post-meta">Sep 25, 2024</div>

        <p>At work we have a <a href="https://stackgres.io/">Stackgres</a> kuberentes cluster that hosts our postgres databases. This allows for high availability, easy data recovery and generally is pretty easy to manage. I admit that when I first started looking at postgres on Kubernetes I was pretty skeptical but it's honestly given me very little to complain about. It does have some issues due to how the cluster was initially configured that I am planning to fix in the future.</p>

        <p>The K8s cluster was setup with GP2 as the default storage class and so the topic came up a few months ago to migrate to GP3 to increase our IOPs and also reduce cost.</p>

        <p>So I thought that it would be pretty easy to migrate from GP2 to GP3 EBS volumes as I have migrated standard EC2 servers using EBS with a quick CLI script or GUI click. I sent in a ticket to <a href="https://ongres.com/">Ongres</a>, the company behind Stackgres to see if they had any guidance on the process. I was expecting again a simple one liner kubectl command or script.</p>

        <p>Instead I received a long procedure and thought I'd document it here...</p>

        <ol>
          <li>Make the cluster leader pod "0". I'm not 100% sure this is needed but it was in my directions. I didn't test this but I figure it will delete whatever pod is not the leader. But again I didn't test.
            <ol>
              <li><code>kubectl exec -it -n &lt;&lt;namespace&gt;&gt; &lt;&lt;stackgres_pod_name&gt;&gt; -c patroni -- patronictl list</code></li>
              <li>If needed switchover: <code>kubectl exec -it -n &lt;&lt;namespace&gt;&gt; &lt;&lt;stackgres_pod_name&gt;&gt; -c patroni -- patronictl switchover</code></li>
            </ol>
          </li>
          <li>Take a backup... take a backup... take a backup! Don't start this process without a recent backup as you are going to delete volumes.</li>
          <li>Set the cluster size to 1, destroying the replica: <code>kubectl edit sgclusters.stackgres.io -n &lt;&lt;namespace&gt;&gt; &lt;&lt;stackgres_cluster_name&gt;&gt;</code></li>
          <li>Use <code>kubectl get pvc</code> to find the volume claim and release it by deleting it.</li>
          <li>User <code>kubectl get pv</code> to find the volume and then delete the volume.</li>
          <li>Set the cluster size to 2, creating a new replica: <code>kubectl edit sgclusters.stackgres.io -n &lt;&lt;namespace&gt;&gt; &lt;&lt;stackgres_cluster_name&gt;&gt;</code></li>
          <li>watch for the replica to be rebuilt and sync up with the leader: <code>kubectl exec -it -n &lt;&lt;namespace&gt;&gt; &lt;&lt;stackgres_pod_name&gt;&gt; -c patroni -- patronictl list</code></li>
          <li>Once the sync is complete, switchover to the replica and then follow the steps to delete the old leader.</li>
        </ol>

        <p>I admit that I made a mistake at one point and deleted a PVC that was still in use. Thankfully the Ongres team was able to help me recover from that. I'll document that in a later post.</p>

        <p>I'm hoping that going forward we can use GP3 as the default storage class for new clusters.</p>
      </article>
    </main>

    <footer>
      <a href="https://www.linkedin.com/in/kevin-spears/">LinkedIn</a> ·
      <a href="https://github.com/kspears/">GitHub</a>
      <p class="footer-location">Oregon</p>
    </footer>
  </div>
</body>
</html>
